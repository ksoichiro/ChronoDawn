// Multi-version build and run tasks (Phase 5: Build Script Enhancement)
// This script defines custom Gradle tasks for building and running the mod
// across multiple Minecraft versions.

// ============================================================
// Build Tasks
// ============================================================

/**
 * Build for Minecraft 1.20.1
 * Usage: ./gradlew build1_20_1
 */
tasks.register('build1_20_1') {
    group = 'chrono dawn build'
    description = 'Build mod for Minecraft 1.20.1'

    doFirst {
        logger.lifecycle('')
        logger.lifecycle('====================================')
        logger.lifecycle('Building for Minecraft 1.20.1...')
        logger.lifecycle('====================================')
        logger.lifecycle('')
    }

    doLast {
        project.exec {
            commandLine './gradlew', 'clean', 'build', '-Ptarget_mc_version=1.20.1', '-x', 'test'
        }
    }
}

/**
 * Build for Minecraft 1.21.1
 * Usage: ./gradlew build1_21_1
 */
tasks.register('build1_21_1') {
    group = 'chrono dawn build'
    description = 'Build mod for Minecraft 1.21.1'

    doFirst {
        logger.lifecycle('')
        logger.lifecycle('====================================')
        logger.lifecycle('Building for Minecraft 1.21.1...')
        logger.lifecycle('====================================')
        logger.lifecycle('')
    }

    doLast {
        project.exec {
            commandLine './gradlew', 'clean', 'build', '-Ptarget_mc_version=1.21.1', '-x', 'test'
        }
    }
}

/**
 * Build for all supported Minecraft versions
 * Usage: ./gradlew buildAll
 */
tasks.register('buildAll') {
    group = 'chrono dawn build'
    description = 'Build mod for all supported Minecraft versions (1.20.1, 1.21.1)'

    doFirst {
        logger.lifecycle('')
        logger.lifecycle('====================================================')
        logger.lifecycle('Building for ALL supported Minecraft versions...')
        logger.lifecycle('Versions: 1.20.1, 1.21.1')
        logger.lifecycle('====================================================')
        logger.lifecycle('')
    }

    doLast {
        def versions = ['1.20.1', '1.21.1']
        def failed = []

        versions.each { version ->
            logger.lifecycle('')
            logger.lifecycle(">>> Building for Minecraft ${version}...")
            logger.lifecycle('')

            try {
                project.exec {
                    commandLine './gradlew', 'clean', 'build', "-Ptarget_mc_version=${version}"
                    errorOutput = System.err
                }
                logger.lifecycle("✅ SUCCESS: Minecraft ${version}")
            } catch (Exception e) {
                logger.error("❌ FAILED: Minecraft ${version}")
                failed.add(version)
            }
        }

        logger.lifecycle('')
        logger.lifecycle('====================================================')
        logger.lifecycle('Build Summary:')
        logger.lifecycle('====================================================')

        if (failed.isEmpty()) {
            logger.lifecycle('✅ All versions built successfully!')
            logger.lifecycle("   - Minecraft 1.20.1")
            logger.lifecycle("   - Minecraft 1.21.1")
        } else {
            logger.lifecycle("❌ ${failed.size()} version(s) failed:")
            failed.each { version ->
                logger.lifecycle("   - Minecraft ${version}")
            }
            throw new GradleException("Build failed for: ${failed.join(', ')}")
        }

        logger.lifecycle('====================================================')
        logger.lifecycle('')
    }
}

// ============================================================
// GameTest Tasks
// ============================================================

/**
 * Run GameTests for all supported Minecraft versions and loaders
 * Usage: ./gradlew gameTestAll
 *
 * Runs sequentially (Architectury Loom requires isolated build state per configuration):
 *   - fabric:runGameTest for 1.20.1, 1.21.1, 1.21.2
 *   - neoforge:runGameTestServer for 1.21.1, 1.21.2
 *
 * Each run uses clean to prevent Architectury Transformer from picking up
 * stale dev JARs from other version configurations.
 * Individual log files are saved to build/gametest-*.log for debugging.
 */
tasks.register('gameTestAll') {
    group = 'chrono dawn test'
    description = 'Run GameTests for all supported Minecraft versions and loaders'

    doLast {
        def configurations = [
            [loader: 'fabric', task: 'runGameTest', version: '1.20.1'],
            [loader: 'fabric', task: 'runGameTest', version: '1.21.1'],
            [loader: 'fabric', task: 'runGameTest', version: '1.21.2'],
            [loader: 'neoforge', task: 'runGameTestServer', version: '1.21.1'],
            [loader: 'neoforge', task: 'runGameTestServer', version: '1.21.2'],
        ]
        def passed = []
        def failed = []

        def gradlew = new File(projectDir, 'gradlew').absolutePath
        def logDir = new File(projectDir, 'build')
        logDir.mkdirs()

        configurations.each { config ->
            def label = "${config.loader} ${config.version}"
            def suffix = "${config.version}-${config.loader}"
            logger.lifecycle('')
            logger.lifecycle(">>> Running GameTests: ${label}...")

            def cmd = [
                gradlew, 'clean',
                ':' + config.loader + ':' + config.task,
                '-Ptarget_mc_version=' + config.version,
                '--parallel',
                '--stacktrace'
            ] as List<String>

            def logFile = new File(logDir, 'gametest-' + suffix + '.log')

            try {
                def pb = new ProcessBuilder(cmd)
                pb.directory(projectDir)
                pb.redirectErrorStream(true)
                pb.redirectOutput(logFile)

                def process = pb.start()
                def exitCode = process.waitFor()

                if (exitCode == 0) {
                    logger.lifecycle("    PASSED: ${label}")
                    passed.add(label)
                } else {
                    logger.error("    FAILED: ${label} (see ${logFile.absolutePath})")
                    failed.add(label)
                }
            } catch (Exception e) {
                logger.error("    ERROR: ${label} - ${e.message}")
                failed.add(label)
            }
        }

        logger.lifecycle('')
        logger.lifecycle('====================================================')
        logger.lifecycle('GameTest Summary:')
        logger.lifecycle('====================================================')

        passed.each { label ->
            logger.lifecycle("   PASSED: ${label}")
        }
        failed.each { label ->
            logger.lifecycle("   FAILED: ${label}")
        }

        logger.lifecycle('')
        logger.lifecycle("Total: ${passed.size()} passed, ${failed.size()} failed")
        logger.lifecycle("Logs: ${logDir.absolutePath}/gametest-*.log")
        logger.lifecycle('====================================================')
        logger.lifecycle('')

        if (!failed.isEmpty()) {
            throw new GradleException("GameTests failed for: ${failed.join(', ')}")
        }
    }
}
