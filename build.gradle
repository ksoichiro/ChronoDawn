plugins {
    id 'dev.architectury.loom' version '1.11-SNAPSHOT' apply false
    id 'architectury-plugin' version '3.4-SNAPSHOT'
    id 'com.gradleup.shadow' version '8.3.6' apply false
}

// Multi-version support: Load version-specific properties
ext.loadVersionProperties = { String version ->
    def propsFile = file("props/${version}.properties")
    if (!propsFile.exists()) {
        throw new GradleException("Version properties not found: ${propsFile.absolutePath}")
    }

    logger.lifecycle("Loading version properties: ${propsFile.name}")
    def props = new Properties()
    propsFile.withInputStream { props.load(it) }

    // Override gradle.properties with version-specific values
    props.each { key, value ->
        project.ext.set(key.toString(), value.toString())
    }

    logger.lifecycle("Target Minecraft version: ${project.ext.minecraft_version}")
}

// Determine target version from command line or use default
def targetVersion = project.findProperty('target_mc_version') ?: '1.21.1'
loadVersionProperties(targetVersion)

architectury {
    minecraft = project.ext.minecraft_version
}

allprojects {
    group = rootProject.maven_group
    version = rootProject.mod_version
}

subprojects {
    apply plugin: 'dev.architectury.loom'
    apply plugin: 'architectury-plugin'
    apply plugin: 'maven-publish'

    // Propagate version-specific properties to subprojects
    ext.minecraft_version = rootProject.ext.minecraft_version
    ext.pack_format = rootProject.ext.pack_format
    ext.compat_package = rootProject.ext.compat_package
    ext.architectury_api_version = rootProject.ext.architectury_api_version
    ext.fabric_loader_version = rootProject.ext.fabric_loader_version
    ext.fabric_api_version = rootProject.ext.fabric_api_version
    ext.neoforge_version = rootProject.ext.neoforge_version
    ext.custom_portal_api_fabric_version = rootProject.ext.custom_portal_api_fabric_version

    repositories {
        maven { url 'https://maven.architectury.dev/' }
        maven { url 'https://maven.neoforged.net/releases/' }
        maven { url 'https://maven.minecraftforge.net/' }
        maven { url 'https://maven.fabricmc.net/' }
        maven { url 'https://maven.parchmentmc.org/' }
        maven { url 'https://maven.blamejared.com' }
        mavenCentral()
    }

    dependencies {
        minecraft "com.mojang:minecraft:$rootProject.ext.minecraft_version"
        mappings loom.officialMojangMappings()
    }

    java {
        withSourcesJar()
        sourceCompatibility = JavaVersion.VERSION_21
        targetCompatibility = JavaVersion.VERSION_21
    }

    tasks.withType(JavaCompile).configureEach {
        it.options.encoding = 'UTF-8'
        it.options.release = 21
    }
}

// Multi-version build tasks (Phase 5: Build Script Enhancement)

/**
 * Build for Minecraft 1.20.1
 * Usage: ./gradlew build1201
 */
tasks.register('build1201') {
    group = 'chrono dawn build'
    description = 'Build mod for Minecraft 1.20.1'

    doFirst {
        logger.lifecycle('')
        logger.lifecycle('====================================')
        logger.lifecycle('Building for Minecraft 1.20.1...')
        logger.lifecycle('====================================')
        logger.lifecycle('')
    }

    doLast {
        project.exec {
            commandLine './gradlew', 'clean', 'build', '-Ptarget_mc_version=1.20.1', '-x', 'test'
        }
    }
}

/**
 * Build for Minecraft 1.21.1
 * Usage: ./gradlew build1211
 */
tasks.register('build1211') {
    group = 'chrono dawn build'
    description = 'Build mod for Minecraft 1.21.1'

    doFirst {
        logger.lifecycle('')
        logger.lifecycle('====================================')
        logger.lifecycle('Building for Minecraft 1.21.1...')
        logger.lifecycle('====================================')
        logger.lifecycle('')
    }

    doLast {
        project.exec {
            commandLine './gradlew', 'clean', 'build', '-Ptarget_mc_version=1.21.1', '-x', 'test'
        }
    }
}

/**
 * Build for all supported Minecraft versions
 * Usage: ./gradlew buildAll
 */
tasks.register('buildAll') {
    group = 'chrono dawn build'
    description = 'Build mod for all supported Minecraft versions (1.20.1, 1.21.1)'

    doFirst {
        logger.lifecycle('')
        logger.lifecycle('====================================================')
        logger.lifecycle('Building for ALL supported Minecraft versions...')
        logger.lifecycle('Versions: 1.20.1, 1.21.1')
        logger.lifecycle('====================================================')
        logger.lifecycle('')
    }

    doLast {
        def versions = ['1.20.1', '1.21.1']
        def failed = []

        versions.each { version ->
            logger.lifecycle('')
            logger.lifecycle(">>> Building for Minecraft ${version}...")
            logger.lifecycle('')

            try {
                project.exec {
                    commandLine './gradlew', 'clean', 'build', "-Ptarget_mc_version=${version}"
                    errorOutput = System.err
                }
                logger.lifecycle("✅ SUCCESS: Minecraft ${version}")
            } catch (Exception e) {
                logger.error("❌ FAILED: Minecraft ${version}")
                failed.add(version)
            }
        }

        logger.lifecycle('')
        logger.lifecycle('====================================================')
        logger.lifecycle('Build Summary:')
        logger.lifecycle('====================================================')

        if (failed.isEmpty()) {
            logger.lifecycle('✅ All versions built successfully!')
            logger.lifecycle("   - Minecraft 1.20.1")
            logger.lifecycle("   - Minecraft 1.21.1")
        } else {
            logger.lifecycle("❌ ${failed.size()} version(s) failed:")
            failed.each { version ->
                logger.lifecycle("   - Minecraft ${version}")
            }
            throw new GradleException("Build failed for: ${failed.join(', ')}")
        }

        logger.lifecycle('====================================================')
        logger.lifecycle('')
    }
}
